name: Build & Release .mrpack

on:
  push:
    branches: ["main"]
    paths:
      - "modrinth.index.json"
      - "overrides/**"
      - ".github/workflows/build-mrpack.yml"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: mrpack-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-slim:
    name: Build .mrpack (nur overrides)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout (mit LFS)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Ensure Git LFS & fetch overrides
        run: |
          set -euxo pipefail
          git lfs install --local
          git lfs pull --include="overrides/**" --exclude=""

          echo "---- Pointer-Check ----"
          PO=$(grep -RIl --exclude-dir=.git -m1 "version https://git-lfs.github.com/spec" overrides || true)
          if [ -n "$PO" ]; then
            echo "::group::Pointer-Dateien entdeckt"
            echo "$PO" | while read -r f; do
              echo "FILE: $f"
              head -n3 "$f" || true
            done
            echo "::endgroup::"
            echo "::error::Git LFS Pointer in overrides gefunden. BinÃ¤rdaten fehlen!"
            exit 1
          fi

      - name: Ensure tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y jq zip unzip rsync

      - name: Validate manifest
        run: |
          test -f modrinth.index.json || { echo "::error::modrinth.index.json fehlt"; exit 1; }

      - name: Read name/version and detect prerelease
        id: meta
        run: |
          # Extract Data
          NAME_RAW=$(jq -r '.name // "Pack"' modrinth.index.json)
          VER_RAW=$(jq -r '.versionId // .version // .version_number // "dev"' modrinth.index.json)
          
          # Clean name and version
          NAME_SAFE=$(printf "%s" "$NAME_RAW" | tr ' ' '_' | tr -cd 'A-Za-z0-9._-')
          VER_SAFE=$(printf "%s" "$VER_RAW" | tr ' ' '_' | tr -cd 'A-Za-z0-9._-')
          
          # Prerelease Check: 
          # If the version does NOT consist solely of numbers and dots (e.g., contains -beta, -preview, etc.)
          # we set is_prerelease to true.
          IS_PRERELEASE="false"
          if [[ ! "$VER_SAFE" =~ ^[0-9.]+$ ]]; then
            IS_PRERELEASE="true"
            echo "Detected Prerelease version: $VER_SAFE"
          fi

          echo "pack_name=$NAME_SAFE" >> "$GITHUB_OUTPUT"
          echo "version=$VER_SAFE" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=$IS_PRERELEASE" >> "$GITHUB_OUTPUT"

      - name: Stage packroot (nur overrides)
        run: |
          rm -rf .packroot build
          mkdir -p .packroot build
          cp modrinth.index.json .packroot/
          if [ -d overrides ]; then
            rsync -a overrides/ .packroot/overrides/
          else
            mkdir -p .packroot/overrides
          fi

      - name: Build .mrpack
        id: package
        run: |
          OUT="build/${{ steps.meta.outputs.pack_name }}-${{ steps.meta.outputs.version }}.mrpack"
          (cd .packroot && zip -X -r "../$OUT" .)
          echo "artifact=$OUT" >> "$GITHUB_OUTPUT"

      - name: Release .mrpack
        if: ${{ !env.ACT }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ format('{0}-{1}', steps.meta.outputs.pack_name, steps.meta.outputs.version) }}
          name: ${{ steps.meta.outputs.pack_name }} v${{ steps.meta.outputs.version }}
          draft: false
          prerelease: ${{ steps.meta.outputs.is_prerelease == 'true' }}
          files: |
            ${{ steps.package.outputs.artifact }}
