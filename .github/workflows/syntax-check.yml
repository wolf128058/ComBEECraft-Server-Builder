name: Syntax, Sort and LFS Check

on:
  pull_request:
    branches:
      - main
      - next

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Wir setzen lfs auf false, damit der Checkout nicht wegen des Quotas abbricht.
          # Die Metadaten für den Check ziehen wir uns manuell.
          lfs: false 

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Check JSON Syntax
        run: |
          jq . modrinth.index.json > /dev/null
          jq . curseforge.index.json > /dev/null

      - name: Verify Sorting
        run: |
          chmod +x sortjson.sh
          ./sortjson.sh
          if [ -n "$(git status --porcelain)" ]; then
            echo "Fehler: Die JSON-Dateien sind nicht korrekt sortiert."
            git diff
            exit 1
          fi

      - name: Verify LFS Integrity
        # "continue-on-error" macht den Test optional. 
        # Der Workflow wird grün, auch wenn dieser Schritt scheitert.
        continue-on-error: true
        run: |
          echo "Prüfe auf korrekte LFS-Pointer (Quota-unabhängig)..."
          
          # Wir prüfen nur die lokale Konfiguration, ohne Dateien vom LFS-Server zu laden
          MISCONFIGURED=$(git lfs status --porcelain | grep -E '^\+' | grep -v 'LFS' || true)
          
          if [ -n "$MISCONFIGURED" ]; then
            echo "Warnung: Folgende Dateien wurden ohne LFS hochgeladen, obwohl sie in .gitattributes stehen:"
            echo "$MISCONFIGURED"
            # Da continue-on-error aktiv ist, markiert exit 1 den Schritt nur als gelb/fehlgeschlagen,
            # lässt aber den gesamten Job für den Merge-Button 'bestehen'.
            exit 1
          fi
          
          echo "LFS Check abgeschlossen (oder wegen Quota übersprungen)."